<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Review job</title>
    <link rel="stylesheet" href="/static/app.css" />
</head>

<body>
    <header class="topbar">
        <div class="nav" aria-label="Primary">
            <a href="/">Home</a>
            <a href="/papers">Papers</a>
            <a href="/reviews">Reviews</a>
            <a href="/feedback">Feedback</a>
        </div>
        <div class="muted" style="font-size: 13px;">Phase 9</div>
    </header>

    <main class="container stack">
        <h1 class="page-title">Review job</h1>
        <p class="subtitle">job: <code id="job_id">{{ job.job_id }}</code></p>

        <div class="row">
            <section class="card" aria-label="Job status">
                <h2 style="margin: 0;">Status</h2>
                <ul>
                    <li>status: <code id="status">{{ job.status }}</code></li>
                    <li>step: <code id="step">{{ job.step }}</code></li>
                    <li>paper: <code id="paper">{{ job.normalized_arxiv_id or job.arxiv_id_or_url }}</code></li>
                    <li>run: <code id="run">{{ job.current_run }}</code> / <code id="runs">{{ job.num_reviews }}</code>
                    </li>
                    <li>messages: <code id="messages">{{ job.messages_count }}</code></li>
                    <li>last_agent: <code id="last_agent">{{ job.last_agent }}</code></li>
                    <li>last_phase: <code id="last_phase">{{ job.last_phase }}</code></li>
                </ul>
                <p class="muted">This page auto-updates every ~2s.</p>
                <p id="err" class="error" style="display:none;"></p>
            </section>

            <section class="card" aria-label="Persisted reviews">
                <h2 style="margin: 0;">Persisted reviews</h2>
                {% if job.persisted_reviews and job.persisted_reviews|length > 0 %}
                <ul id="persisted_list">
                    {% for r in job.persisted_reviews %}
                    <li>
                        run <code>{{ r.run }}</code>:
                        {% if r.review_id %}
                        <a href="/reviews/{{ r.review_id }}">{{ r.review_id }}</a>
                        {% else %}
                        <span class="muted">{{ r.error }}</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="muted" id="persisted_empty">None yet.</p>
                <ul id="persisted_list" style="display:none;"></ul>
                {% endif %}
            </section>
        </div>

        <section class="card" aria-label="Artifacts">
            <h2 style="margin: 0;">Artifacts</h2>
            {% if job.artifacts and job.artifacts|length > 0 %}
            {% for a in job.artifacts %}
            <h3 style="margin-bottom: 0.25rem;">Run {{ a.run }}</h3>
            <ul>
                <li><a href="/download/{{ a.report_md }}">{{ a.report_md }}</a></li>
                {% if a.claims_json %}<li><a href="/download/{{ a.claims_json }}">{{ a.claims_json }}</a></li>{% endif
                %}
                {% if a.summary_json %}<li><a href="/download/{{ a.summary_json }}">{{ a.summary_json }}</a></li>{%
                endif %}
            </ul>
            <details>
                <summary>Report preview</summary>
                <pre>{{ a.report_preview }}</pre>
            </details>
            {% endfor %}
            {% else %}
            <p class="muted">No artifacts yet.</p>
            {% endif %}
        </section>

        <section class="card" aria-label="Adjudication log">
            <h2 style="margin: 0;">Adjudication log</h2>
            <p class="muted">Append-only job events (Supabase). Shows while adjudicating.</p>
            <pre id="events">(loading)</pre>
        </section>
    </main>

    <script>
        const jobId = document.getElementById('job_id').innerText;

        function escapeHtml(s) {
            return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        async function tick() {
            try {
                const r = await fetch(`/jobs/${jobId}.json`, { cache: 'no-store' });
                const data = await r.json();
                if (!data.ok) {
                    document.getElementById('err').style.display = 'block';
                    document.getElementById('err').innerText = data.error || 'Job status error';
                    return;
                }

                const job = data.job;
                document.getElementById('status').innerText = job.status;
                document.getElementById('step').innerText = job.step;
                document.getElementById('paper').innerText = job.normalized_arxiv_id || job.arxiv_id_or_url;
                document.getElementById('run').innerText = job.current_run;
                document.getElementById('runs').innerText = job.num_reviews;
                document.getElementById('messages').innerText = job.messages_count;
                document.getElementById('last_agent').innerText = job.last_agent || '';
                document.getElementById('last_phase').innerText = job.last_phase || '';

                if (job.error) {
                    document.getElementById('err').style.display = 'block';
                    document.getElementById('err').innerText = job.error;
                }

                // Persisted list
                const list = document.getElementById('persisted_list');
                const empty = document.getElementById('persisted_empty');
                if (list) {
                    const items = Array.isArray(job.persisted_reviews) ? job.persisted_reviews : [];
                    if (items.length > 0) {
                        if (empty) empty.style.display = 'none';
                        list.style.display = 'block';
                        list.innerHTML = items.map((x) => {
                            const run = escapeHtml(x.run);
                            if (x.review_id) {
                                const rid = escapeHtml(x.review_id);
                                return `<li>run <code>${run}</code>: <a href="/reviews/${rid}">${rid}</a></li>`;
                            }
                            return `<li>run <code>${run}</code>: <span class="muted">${escapeHtml(x.error || 'error')}</span></li>`;
                        }).join('');
                    }
                }

                // Stop polling once adjudicated/error.
                if (job.status === 'adjudicated' || job.status === 'complete' || job.status === 'error') {
                    return;
                }
            } catch (e) {
                document.getElementById('err').style.display = 'block';
                document.getElementById('err').innerText = String(e);
            }
            setTimeout(tick, 2000);
        }

        async function tickEvents() {
            const el = document.getElementById('events');
            if (!el) return;
            try {
                const r = await fetch(`/jobs/${jobId}/events.json?limit=80`, { cache: 'no-store' });
                const data = await r.json();
                if (!data.ok) {
                    el.innerText = data.error || 'No events available';
                } else {
                    const events = Array.isArray(data.events) ? data.events : [];
                    const lines = events.slice(-80).map((e) => {
                        const ts = e.created_at || '';
                        const t = e.event_type || '';
                        const p = JSON.stringify(e.payload || {});
                        return `${ts}  ${t}  ${p}`;
                    });
                    el.innerText = lines.join('\n') || '(no events)';
                }
            } catch (e) {
                el.innerText = String(e);
            }
            setTimeout(tickEvents, 2000);
        }

        setTimeout(tick, 500);
        setTimeout(tickEvents, 700);
    </script>
</body>

</html>
